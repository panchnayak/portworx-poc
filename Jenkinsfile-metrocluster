pipeline {
    agent  any
    stages {
        stage('Setup parameters') {
            steps {
                script {
                    properties([
                        parameters([
                            string(defaultValue: 'aws-pnayak',name: 'AWS_CREDS',trim: true),
                            choice(choices: ['Default: Do Nothing', 'Deploy Metro Cluster', 'Destroy Metro Cluster'],name: 'ACTION_REQUESTING'),
                            string(defaultValue: 'pnayak-eks',name: 'CLUSTER_NAME',trim: true),
                            string(defaultValue: 'pnayak-eks-ng',name: 'NODEGROUP_NAME',trim: true),
                            string(defaultValue: 'Security-Group-ID-for-ETCD-Instance',name: 'SG_ID',trim: true),
                            string(defaultValue: 'Subnet-ID-For-ETCD-Instance',name: 'SUBNET_ID',trim: true),
                            string(defaultValue: 'us-east-1',name: 'FIRST_REGION_NAME',trim: true),
                            string(defaultValue: 'us-east-1',name: 'SECOND_REGION_NAME',trim: true)
                        ])
                    ])
                }
            }
        }
        stage('Create ETCD Cluster') { 
            when { expression { params.ACTION_REQUESTING == 'Deploy Metro Cluster' } }
            steps {
                withAWS(credentials: params.AWS_CREDS, region: params.FIRST_REGION_NAME) {
                    echo "Creating Separate SingleNode ETCD Cluster in the region:"+ params.FIRST_REGION_NAME
                    echo "./aws/scripts/deploy-etcd-cluster.sh "+ params.SG_ID+"  "+params.SUBNET_ID
                    sh "./aws/scripts/deploy-etcd-cluster.sh sg-035dbbea77f8bcd78  subnet-00e830763fcde7b86"
                }
            }
        }
        stage('EKS Cluster') {
            parallel {
                stage('Create EKS Clusters ') {
                    when { expression { params.ACTION_REQUESTING == 'Deploy EKS Cluster-x'  }  }
                        steps {
                            withAWS(credentials: params.AWS_CREDS, region: params.FIRST_REGION_NAME) {
                                echo "Deploying EKS Cluster "+params.CLUSTER_NAME+"1 in the region:"+ params.FIRST_REGION_NAME
                                sh "./aws/scripts/create-eks-cluster.sh "+ params.CLUSTER_NAME+"  "+params.NODEGROUP_NAME+"  "+params.FIRST_REGION_NAME
                            }
                        }
                }
                stage('Destroy Portworx Cluster') {
                    when { expression { params.ACTION_REQUESTING == 'Destroy EKS Cluster'  }  }
                    steps {
                        withAWS(credentials: params.AWS_CREDS, region: params.FIRST_REGION_NAME) {
                            echo "Deleting Portworx from on EKS Cluster"
                            sh "kubectl delete -f portworx/px-operator.yaml"
                            sh "kubectl delete -f portworx/px-specs.yaml"
                        }
                    }
                }
            }
        }
        stage('Portworx Cluster') {
            parallel {
                stage('Deploy Portworx Storage Cluster') {
                    when { expression { params.ACTION_REQUESTING == 'Deploy EKS Cluster'  }  }
                    steps {
                        withAWS(credentials: params.AWS_CREDS, region: params.FIRST_REGION_NAME) {
                            echo "Installing Portworx on EKS Cluster"
                            sh "kubectl apply -f portworx/px-operator.yaml"
                            sh "kubectl apply -f portworx/px-specs.yaml"
                        }
                    }
                }
                stage('Destroy EKS Clusters ') {
                    when { expression { params.ACTION_REQUESTING == 'Destroy EKS Cluster'  }  }
                    steps {
                        withAWS(credentials: params.AWS_CREDS, region: params.FIRST_REGION_NAME) {
                            echo "Destroying EKS Cluster "+params.CLUSTER_NAME+"1 in the region:"+ params.FIRST_REGION_NAME
                            sh "./aws/scripts/destroy-eks-cluster.sh "+ params.CLUSTER_NAME+"  "+params.FIRST_REGION_NAME
                        }
                    }
                }
            }
        }
    }
}

        
        
              

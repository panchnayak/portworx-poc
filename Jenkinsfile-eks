pipeline {
    agent  any
    stages {
        stage('Setup parameters') {
            steps {
                script {
                    properties([
                        parameters([
                            choice(choices: ['Default: Do Nothing', 'Deploy EKS Cluster', 'Destroy EKS Cluster'],name: 'ACTION_REQUESTING'),
                            string(defaultValue: 'pnayak-eks',name: 'CLUSTER_NAME',trim: true),
                            string(defaultValue: 'pnayak-eks-ng',name: 'NODEGROUP_NAME',trim: true),
                            string(defaultValue: 'us-east-1',name: 'FIRST_REGION_NAME',trim: true),
                        ])
                    ])
                }
            }
        }
      stage('Create EKS Clusters') {
            when { expression { params.ACTION_REQUESTING == 'Deploy EKS Cluster-x'  }  }
            steps {
                echo "Deploying EKS Cluster "+params.CLUSTER_NAME+"1 in the region:"+ params.FIRST_REGION_NAME
                sh "./aws/scripts/create-eks-cluster.sh "+ params.CLUSTER_NAME+"  "+params.NODEGROUP_NAME+"  "+params.FIRST_REGION_NAME
            }
      }       
      stage('Deploy Portworx Storage Cluster') {
            when { expression { params.ACTION_REQUESTING == 'Deploy EKS Cluster'  }  }
            steps {
                echo "Installing Portworx on EKS Cluster"
                sh "kubectl apply -f ./portworx/px-operator.yaml"
                sh "kubectl apply -f ./portworx/px-specs.yaml"
            }
      }
      stage('Destroy Portworx Cluster') {
            when { expression { params.ACTION_REQUESTING == 'Destroy EKS Cluster'  }  }
            steps {
                echo "Deleting Portworx from on EKS Cluster"
                sh "kubectl delete -f ./portworx/px-specs.yaml"
                sh "kubectl delete -f ./portworx/px-operator.yaml"
            }
      }
      stage('Destroy EKS Clusters') {
            when { expression { params.ACTION_REQUESTING == 'Destroy EKS Cluster'  }  }
            steps {
                echo "Deploying EKS Cluster "+params.CLUSTER_NAME+"1 in the region:"+ params.FIRST_REGION_NAME
                sh "./aws/scripts/destroy-eks-cluster.sh "+ params.CLUSTER_NAME+"  "+params.NODEGROUP_NAME+"  "+params.FIRST_REGION_NAME
            }
      }
    }
}
       
